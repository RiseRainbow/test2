<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>HTML5</title>
    <!--[if IE]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <style>
   article, aside, details, figcaption, figure, footer,header,
   hgroup, menu, nav, section { display: block; }
  </style>
</head>
<body>
<p>Привет, мbр</p>
<a href="prod2.html">PROD2</a>

<script>
    (function (d) {

    var cfg = {
        enabled: false
    };

    var _conn, metrika;

    var APIConnection = function(url, hello) {
        var conn, seq = 0, ack = 0, lastSentAck = 0, sid, reqSeq = 0, reqCallbacks = {};

        var self = this;

        var unackedMessages;

        function sendMessage(m) {
            if (conn) {
                var s = JSON.stringify(m);
                if (self.debugOut) {
                    self.debugOut(m);
                }
                conn.send(s);
            }
        }
        function onOpen(event) {
            var h;
            if (sid) {
                h = {
                    sid: sid,
                    ack: ack
                };
                if (unackedMessages && unackedMessages.length > 0) {
                    h.seq = unackedMessages[0].seq;
                    var payloads = [];
                    for (var i = 0; i < unackedMessages.length; i++) {
                        payloads.push(unackedMessages[i].payload);
                    }
                    h.payloads = payloads;
                }
            } else {
                h = hello;
            }
            sendMessage(h);
        }
        function onClose(event) {
            if (sid && self.ondisconnect) {
                self.ondisconnect();
            }
            conn = undefined;
        }
        function onError(event) {
            if (self.onError) {
                self.onError(event);
            }
        }
        function receivePayload(d) {
            removeAcked(d.ack);
            if (d.payloads) {
                var curSeq = d.seq;
                for (var i = 0; i < d.payloads.length; i++) {
                    if (curSeq > ack) {
                        processPayload(d.payloads[i]);
                        ack = curSeq;
                        curSeq++;
                    }
                }
            } else {
                if (d.seq > ack) {
                    if (d.payload) {
                        processPayload(d.payload);
                    }
                    ack = d.seq;
                }
            }
            if (ack - lastSentAck > 4) {
                sendMessage({ack: ack});
                lastSentAck = ack;
            }

        }
        function processPayload(p) {
            if (!p) return;
            switch(p.What) {
            case "request":
                if (self.onrequest) {
                    var resp = self.onrequest(p[""]);
                    self.send({What: "response", id: p.id, "": resp});
                }
                break;
            case "response":
                if (p.id != null) {
                    var cb = reqCallbacks[p.id];
                    if (cb) {
                        cb(p[""]);
                        delete reqCallbacks[p.id];
                    }
                }
                break;
            default:
                if (self.onMessage) {
                    self.onMessage(p);
                }
                break;
            }
        }
        function handleMessage(event) {
            if (self.debugIn) {
                self.debugIn(event.data);
            }
            var d = JSON.parse(event.data);
            if (d.bye) {
                sid = undefined;
                ack = 0;
                seq = 0;
                lastSentAck = 0;
                unackedMessages = undefined;
                if (self.onClose) {
                    self.onClose();
                }
            } else {
                receivePayload(d)
            }
        }
        function handleHelloResponse(event) {
            if (self.debugIn) {
                self.debugIn(event.data);
            }
            var d = JSON.parse(event.data);
            if (d.status === "ok") {
                if (self.onConnected) {
                    self.onConnected();
                }
                if (d.sid) {
                    sid = d.sid;
                } else {
                    receivePayload(d);
                }
                conn.onmessage = handleMessage;
            } else if (d.status === "error" && d.error === "Invalid session") {
                sid = null;
                if (hello && hello.sid) {
                    delete hello.sid;
                }
                setTimeout(self.connect, 200)
            }
        }
        function removeAcked(ack) {
            if (unackedMessages && unackedMessages.length > 0) {
                if (unackedMessages[unackedMessages.length - 1].seq <= ack) {
                    unackedMessages = undefined;
                } else {
                    while (unackedMessages.length > 0 && unackedMessages[0].seq <= ack) {
                        unackedMessages.shift();
                    }
                }
            }
        }
        self.connect = function() {
            try {
                if (!conn) {
                    conn = new WebSocket(url);
                    conn.onopen = onOpen;
                    conn.onmessage = handleHelloResponse;
                    conn.onclose = onClose;
                    conn.onerror = onError;
                }
            } catch (e) {
                onError(e)
            }
        };
        self.send = function(payload) {
            seq++;
            var m = {
                seq: seq,
                ack: ack,
                payload: payload
            };
            lastSentAck = ack;
            if (unackedMessages) {
                unackedMessages.push(m);
            } else {
                unackedMessages = [ m ];
            }
            sendMessage(m);
        };
        self.sendRequest = function(request, callback) {
            if (typeof(callback) === "function") {
                var reqId = reqSeq++;
                var payload = {What: "request", id: reqId, "": request};
                reqCallbacks[reqId] = callback;
                self.send(payload);
            } else {
                self.send(request);
            }
        };
        self.disconnect = function() {
            conn.close();
            conn = undefined;
        }
    };

    var icaret = {
        caret : function(input, begin, end) {
            if (typeof begin === 'number') {
                end = (typeof end === 'number') ? end : begin;

                if (input.setSelectionRange) {
                    input.setSelectionRange(begin, end)
                } else if (input.createTextRange) {
                    var range = input.createTextRange()
                    range.collapse(true);
                    range.moveEnd('character', end);
                    range.moveStart('character', begin);
                    range.select();
                }
                return
            }

            if (input.setSelectionRange) {
                begin = input.selectionStart;
                end = input.selectionEnd;
            } else if (d.selection && d.selection.createRange) {
                var range = d.selection.createRange();
                begin = 0 - range.duplicate().moveStart('character', -100000);
                end = begin + range.text.length;
            }
            return  { begin: begin, end: end }
        },


        shiftR : function(pos) {
            var i, c, j, t

            c = this.getPlaceHolder(pos)
            for (i = pos; i < this.len; i++) {
                if (!this.tests[i])
                    continue

                j = this.seekNext(i)
                t = this.buffer[i]

                this.buffer[i] = c
                if (j < this.len && this.tests[j].test(t)) {
                    c = t
                } else {
                    break
                }
            }
        },

        clearBuffer : function(start, end) {
            var i

            for (i = start; i < end && i < this.len; i++) {
                if (!this.tests[i])
                    continue

                this.buffer[i] = this.getPlaceHolder(i)
            }
        },

        shiftL : function(begin, end) {
            var i, j

            if (begin < 0)
                return

            j = this.seekNext(end)
            for (i = begin; i < this.len; i++) {
                if (!this.tests[i])
                    continue

                if (j < this.len && this.tests[i].test(this.buffer[j])) {
                    this.buffer[i] = this.buffer[j]
                    this.buffer[j] = this.getPlaceHolder(j)
                } else {
                    break
                }

                j = this.seekNext(j)
            }

            this.writeBuffer()
        },

        initBuffer : function() {
            this.len = this.placeHolder.length
            this.rx = new RegExp('[0-9]')
            this.tests = []

            var dgts = this.placeHolder.split('')
            for (var x in dgts)  {
                if (dgts[x] == '_') {
                    this.tests.push(new RegExp('[0-9]'))
                    if (this.firstNonMaskPos === null)
                        this.firstNonMaskPos = x
                } else {
                    this.tests.push(null)
                }

                this.buffer[x] = this.getPlaceHolder(x)
            }
        },

        seekNext : function(pos) {
            while (++pos < this.len && !this.tests[pos]);
            return pos;
        },

        seekPrev : function(pos) {
            while (--pos >= 0 && !this.tests[pos]);
            return pos;
        },

        getPlaceHolder : function(i) {
            if (i < this.placeHolder.length)
                return this.placeHolder.charAt(i)

            return this.placeHolder.charAt(0)
        },

        checkVal : function(input, allow) {
            var test = input.value
            var lastMatch = -1
            var i, c, pos

            for (i = 0, pos = 0; i < this.len; i++) {
                if (this.tests[i]) {
                    this.buffer[i] = this.getPlaceHolder(i)
                    while (pos++ < test.length) {
                        c = test.charAt(pos - 1)
                        if (this.tests[i].test(c)) {
                            this.buffer[i] = c
                            lastMatch = i
                            break
                        }
                    }

                    if (pos > test.length) {
                        this.clearBuffer(i + 1, this.len)
                        break
                    }
                } else {
                    if (this.buffer[i] === test.charAt(pos))
                        pos++

                    if (i < this.len)
                        lastMatch = i
                }
            }

            if (allow) {
                this.writeBuffer()
            } else if (lastMatch + 1 < this.len) {
                if (input.value)
                    input.value = ''

                this.clearBuffer(0, this.len)
            } else {
                this.writeBuffer()
                input.value = input.value.substring(0, lastMatch + 1)
            }

            return i
        },

        buffer : [],

        writeBuffer : function() {
            var inp = f.getElement('itlcb-input');

            inp.value = this.buffer.join('');

            if (this.isValidValue(inp))
                f.enableCallButton();
            else
                f.disableCallButton();
        },

        isValidValue: function(input) {
            var rex;

            rex = cfg.phonepattern.replace(/_/g, '\\d');
            rex = rex.replace('(', '\\(');
            rex = rex.replace(')', '\\)');
            rex = rex.replace('+', '\\+');
            rex = new RegExp('^' + rex + '$');

            return rex.test(input.value);
        },

        placeHolder: cfg.phonepattern,
        firstNonMaskPos: null,
        len : -1,
        oldVal : ''
    };

    var Metrika = function() {
        var yandex = (function() {
            var array = [], counters;
            if (typeof ym === 'function') {
                for (var i in ym.a) {
                    counters = ym.a[i];
                    if (counters[1] === 'init') {
                        array.push(counters[0]);
                    }
                }
                return function(name) {
                    for (var i in array)
                        ym(array[i], 'reachGoal', String(name));
                };
            }
            return;
        })();
        var google = (function() {
            var category = 'Callback';
            if (typeof gtag === 'function') {
                return function(name) {
                    gtag('event', String(name), {'event_category': category});
                };
            } else if (typeof ga === 'function') {
                return function(name) {
                    ga('send', 'event', category, String(name));
                };
            }
            return;
        })();

        this.addGoal = function(name) {
            if (typeof yandex === 'function') {
                yandex(name);
            }
            if (typeof google === 'function') {
                google(name);
            }
        };
    };

    var f = {

        ua : '',

        isAndroid : false,
        isChrome : false,

        callTimer: null,

        timeSpent : 0,
        pagesViewed : 0,

        left: false,
        step: 1,
        typeAnimation: null,

        appendStyle : function() {
            /*  https://kb.itoolabs.com/pages/viewpage.action?pageId=65177102  */
            var style = document.createElement("style");
            style.type = "text/css";
            style.innerHTML = "" +
                "@font-face {\n" +
                "  font-family: 'cb-icons';\n" +
                "  src: url('" + cfg.mediaPath + "/cb-icons.ttf') format('truetype');\n" +
                "}";
            document.getElementsByTagName("head")[0].appendChild(style);

            var e = d.createElement('link');
            e.type = 'text/css';
            e.rel = 'stylesheet';
            e.media = 'all';
            e.href = cfg.mediaPath + '/media/callback/css/widget' + cfg.widgetcode + '.css';
            d.body.insertBefore(e, d.body.lastChild);
        },

        getElement : function(id) {
            return d.getElementById(id)
        },

        removeClass: function(mobj, classes) {
            var i;
            var cArray = classes.split(/[\s]+/);

            for (i = 0; i < cArray.length; i ++) {
                if (mobj.classList) {
                    mobj.classList.remove(cArray[i]);
                } else {
                    var rx = new RegExp('(^|\\b)' + cArray[i].split(' ').join('|') + '(\\b|$)', 'gi');
                    mobj.className = mobj.className.replace(rx, ' ');
                }
            }
        },

        addClass: function(mobj, classes) {
            var i;
            var cArray = classes.split(/[\s]+/);

            for (i = 0; i < cArray.length; i++) {
                if (f.hasClass(mobj, cArray[i]))
                    continue;

                if (mobj.classList) {
                    mobj.classList.add(cArray[i]);
                } else {
                    mobj.className += ' ' + cArray[i];
                }
            }

        },

        hasClass: function(mobj, className) {
            if (mobj.classList)
                return mobj.classList.contains(className)

            var rx = new RegExp('(^| )' + className + '( |$)', 'gi');

            return rx.test(mobj.className)
        },

        on: function(el, myevent, func) {
            if (el.addEventListener) {
                el.addEventListener(myevent, func);
            } else {
                el.attachEvent('on' + myevent, func);
            }
        },

        trigger: function(el, myevent, evobj, data) {
            var c, e;

            if (d.dispatchEvent) {
                switch (myevent) {
                case 'click':
                case 'mousedown':
                case 'mouseup':
                    e = 'MouseEvents';
                    break;
                case 'keyup':
                    e = 'KeyboardEvent';
                    break;
                case 'focus':
                case 'change':
                case 'blur':
                case 'select':
                default:
                    e = 'HTMLEvents';
                }

                if (!evobj) {
                    c = d.createEvent(e);

                    c.initEvent(myevent, myevent != 'change', true);
                    c.synthetic = true;
                    c.view = window;
                    c.altKey = false;
                    c.ctrlKey = false;
                    c.shiftKey = false;
                    c.metaKey = false;
                    c.keyCode = data.charCodeAt(0)
                } else
                    c = evobj;

                el.dispatchEvent(c, true, true);
            }
        },

        getOptionForAnimation: function(settings) {
            var option = "", side = "";
            if (settings && settings.positionButton && settings.positionWidget) {
                side = settings.positionButton.match(/(right|left)/)[0];
                settings = String(settings.positionWidget) + "-" + side;
            }

            if (settings === "1-left" || settings === "1-right") {
                option = "bottom";
            } else if (settings === "2") {
                option = "opacity";
            } else if (settings === "3-right") {
                option = "right";
            } else if (settings === "3-left") {
                option = "left";
            }

            return option;
        },

        hide: function(elemId) {
            var el = this.getElement(elemId);

            var animation = function(settings) {
                var option = f.getOptionForAnimation(settings);

                el.style.transition = "all 100ms linear";
                if (option === "opacity") {
                    el.style.opacity = 0;
                    el.style.visibility = "hidden";
                } else if (option === "right") {
                    el.style.right = "-" + el.offsetWidth + "px";
                    el.style.visibility = "hidden";
                } else if (option === "left") {
                    el.style.left = "-" + el.offsetWidth + "px";
                    el.style.visibility = "hidden";
                } else if (option === "bottom") {
                    el.style.bottom = "-" + el.offsetHeight + "px";
                    el.style.visibility = "hidden";
                } else {
                    el.style.transition = "";
                    el.style.visibility = "hidden";
                }
            };
            animation();
            return { animation: animation };
        },
        show: function(elemId) {
            var el = this.getElement(elemId);
            el.style.visibility = "visible";

            var animation = function(settings) {
                var option = f.getOptionForAnimation(settings);

                el.style.transition = "all 100ms linear";
                if (option === "opacity") {
                    el.style.opacity = 1;
                } else if (option === "right") {
                    el.style.right = "0px";
                } else if (option === "left") {
                    el.style.left = "0px";
                } else if (option === "bottom") {
                    el.style.bottom = "20px";
                }
            };
            return { animation: animation };
        },

        trim: function(val) {
            return val.replace(/^[\s\uFEFF]+|[\s\uFEFF]+$/g, 'qqq')
        },

        setCookie: function(name, value, seconds) {
            var expires = '';
            if (seconds) {
                var date = new Date();
                date.setTime(date.getTime() + (seconds * 1000));
                expires = '; expires=' + date.toUTCString();
            }

            document.cookie = name + '=' + (value || '')  + expires + '; path=/';
        },

        getCookie: function(name) {
            var nameEQ = name + '=';
            var ca = document.cookie.split(';');

            for (var i=0; i < ca.length; i++) {
                var c = ca[i];
                while (c.charAt(0)==' ')
                    c = c.substring(1, c.length);

                if (c.indexOf(nameEQ) == 0)
                    return c.substring(nameEQ.length, c.length);
            }

            return null;
        },

        setPositionCallback: function(position) {
            var elStyle = this.getElement('itlcb-call-btn').style;
            switch (position) {
            case "bottom-right":
                elStyle.cssText = 'right: 0px; bottom: 0px;';
                break;
            case "bottom-left":
                elStyle.cssText = 'left: 0px; bottom: 0px;';
                break;
            case "top-right":
                elStyle.cssText = 'right: 0px; top: 0px;';
                break;
            case "top-left":
                elStyle.cssText = 'left: 0px; top: 0px;';
                break;
            default:
                elStyle.cssText = 'right: 0px; bottom: 0px;';
            }
        },
        setColors: function() {
            var colors = JSON.parse(cfg.colors) || {};
            var $btn = this.getElement("itlcb-call-btn");
            var $btnCall = this.getElement("itlcb-do-call");
            var $popup = document.querySelectorAll(".itlcb-widget-body, .itlcb-call-info-block, .itlcb-close-cross");
            var $text = document.querySelectorAll(".itlcb-widget-body *:not(.itlcb-phone-input), .itlcb-call-info-block *");
            var shadeColor2 = function(color, percent) {
                var f=parseInt(color.slice(1),16),t=percent<0?0:255,p=percent<0?percent*-1:percent,R=f>>16,G=f>>8&0x00FF,B=f&0x0000FF;
                return "#"+(0x1000000+(Math.round((t-R)*p)+R)*0x10000+(Math.round((t-G)*p)+G)*0x100+(Math.round((t-B)*p)+B)).toString(16).slice(1);
            };

            var style = document.createElement("style");
            style.type = "text/css";
            style.innerHTML =
                "#itlcb-wrapper.itlcb-opened .itlcb-call-btn.background-callback  { background-color: " + colors.button + "; } \n" +
                "#itlcb-wrapper.itlcb-opened .itlcb-form-call-btn.itlcb-btn-disabled.background-callback  { background-color: " + shadeColor2(colors.button, -0.1) + "; box-shadow: 0 2px 0 0 " + shadeColor2(colors.button, -0.3) + ";} \n" +
                "#itlcb-wrapper.itlcb-opened .itlcb-form-call-btn.background-callback { background-color: " + colors.button + "; box-shadow: 0 2px 0 0 " + shadeColor2(colors.button, -0.3) + "; } \n" +
                "#itlcb-wrapper.itlcb-opened #itlcb-do-call.background-callback:not(.itlcb-btn-disabled):hover { box-shadow: 0 2px 0 0 " + shadeColor2(colors.button, -0.3) + "; } \n" +
                "#itlcb-wrapper.itlcb-opened #itlcb-do-call.background-callback:not(.itlcb-btn-disabled):active { background-color: " + colors.button + "; box-shadow: 0 -2px 0 0 " + shadeColor2(colors.button, -0.3) + "; } \n";

            document.getElementsByTagName("head")[0].appendChild(style);

            if (colors.button) {
                this.addClass($btn, "background-callback");
                this.addClass($btnCall, "background-callback");
            }
            if (colors.popup && colors.text) {
                for (var i = 0; i < $popup.length; i++) {
                    $popup[i].style.backgroundColor = colors.popup;
                }
                for (var i = 0; i < $text.length; i++) {
                    $text[i].style.color = colors.text;
                }
            }
        },
        setPositionWidget: function(positionButton) {
            var elStep2 = this.getElement('itlcb-step2'),
                elStep3 = this.getElement('itlcb-step3'),
                elStep4 = this.getElement('itlcb-step4'),
                side = positionButton.match(/(right|left)/)[0] || "right";
            if (side === "left") {
                this.addClass(elStep2, "left");
                this.addClass(elStep3, "left");
                this.addClass(elStep4, "left");
            }
        },
        initWidget : function() {
            if (!cfg.enabled) return;
            this.ua = navigator.userAgent;
            this.isAndroid = /android/i.test(this.ua);
            this.isChrome = /chrome/i.test(this.ua);
            this.isSafari = /safari/i.test(this.ua);
            this.isMobile = /mobile/i.test(this.ua);
            this.left = false;
            this.typeAnimation = { positionButton: cfg.callbutton, positionWidget: cfg.widgetcode };

            metrika = new Metrika();

            var staleDiv = this.getElement('itlcb-wrapper');
            if (staleDiv != null)
                d.body.removeChild(staleDiv);

            var div = d.createElement('div');

            div.setAttribute('id', 'itlcb-wrapper');
            this.addClass(div, 'itlcb-opened');

            div.insertAdjacentHTML('beforeend', cfg.html);
            d.body.appendChild(div);

            this.setPositionCallback(cfg.callbutton);
            this.setPositionWidget(cfg.callbutton);

            this.setColors();
            this.on(this.getElement('itlcb-call-btn'), 'click', function (e) {
                f.showStep(2);
                input.focus();
                metrika.addGoal("ITL_CALLBACK_OPEN");
            });
            this.on(this.getElement('itlcb-input'), 'click', function () {
                metrika.addGoal("ITL_CALLBACK_FILL");
            });
            var closeBtnClick = function () {
                if (f.callTimer) f.callTimer.stop();
                f.showStep(1);
                metrika.addGoal("ITL_CALLBACK_CLOSE");
            };
            this.on(this.getElement('itlcb-close-btn'), 'click', function() {closeBtnClick()});
            this.on(this.getElement('itlcb-close-btn2'), 'click', function() {closeBtnClick()});
            this.on(this.getElement('itlcb-close-btn3'), 'click', function() {closeBtnClick()});
            this.on(this.getElement('itlcb-bg-fill'), 'click', function (e) {closeBtnClick()});

            var input = this.getElement('itlcb-input');
            icaret.initBuffer();

            this.on(this.getElement('itlcb-do-call'), 'click', function (e) {
                if (!icaret.isValidValue(input)) return;
                metrika.addGoal("ITL_CALLBACK_CALL");
                f.initCall();
            });

            this.showStep(1);

            this.on(input, 'paste', function(e) {
                setTimeout(function() {
                    var pos = icaret.checkVal(input, true);
                    icaret.caret(input, pos)
                }, 10)
            });

            this.on(input, 'keypress', function(e) {
                var k = e.which || e.keyCode;
                var p, c, next;

                if (e.ctrlKey || e.altKey || e.metaKey || k < 32)
                    return;

                if (k === 13 || !k)
                    return;

                var pos = icaret.caret(input);

                if (pos.end - pos.begin !== 0) {
                    icaret.clearBuffer(pos.begin, pos.end);
                    icaret.shiftL(pos.begin, pos.end - 1);
                    icaret.caret(input, Math.max(icaret.firstNonMaskPos, pos.begin))
                }


                p = icaret.seekNext(pos.begin - 1);
                if (p < icaret.len) {
                    c = String.fromCharCode(k);

                    if (icaret.tests[p].test(c)) {
                        icaret.shiftR(p);
                        icaret.buffer[p] = c;

                        icaret.writeBuffer();
                        next = icaret.seekNext(p);
                        icaret.caret(input, next)
                    }
                }

                e.preventDefault()
            });

            this.on(input, 'focus', function(e) {
                icaret.to = setTimeout(function() {
                    for (var i = 0; i < icaret.len; i++) {
                        if (icaret.buffer[i] === '_')
                            break;
                    }

                    var pos = icaret.seekNext(i - 1);
                    icaret.caret(input, pos, pos)
                }, 60);
            });

            this.on(input, 'click', function(e) {
                icaret.to = setTimeout(function() {
                    for (var i = 0; i < icaret.len; i++) {
                        if (icaret.buffer[i] == '_')
                            break;
                    }

                    var pos = icaret.seekNext(i - 1)
                    icaret.caret(input, pos, pos)
                }, 60);
            });

            this.on(input, 'blur', function(e) {
                clearTimeout(icaret.to)
            });

            this.on(input, 'keydown', function(e) {
                var pos, begin, end;
                var evt = e || window.event;
                var keyCode = evt.keyCode;
                var curVal = input.value;

                icaret.oldVal = curVal;

                // left, right
                if (keyCode == 37 || keyCode == 39) {
                    e.preventDefault()
                }
                // bs, delete
                if (keyCode === 8 || keyCode === 46 || keyCode === 127) {
                    pos = icaret.caret(input);

                    begin = pos.begin;
                    end = pos.end;

                    if (end - begin === 0) {
                        begin = keyCode !== 46 ? icaret.seekPrev(begin) : (end = icaret.seekNext(begin - 1));
                        end = keyCode === 46 ? icaret.seekNext(end) : end
                    }

                    icaret.clearBuffer(begin, end);
                    icaret.shiftL(begin, end - 1);
                    icaret.caret(input, Math.max(icaret.firstNonMaskPos, begin));
                    e.preventDefault();
                } else if (keyCode === 13) { // enter
                    if (!icaret.isValidValue(input)) return;
                    f.initCall();
                } else if (keyCode === 27) { //esc
                    f.showStep(1);

                    e.preventDefault()
                }
            });

            if ((this.isAndroid && this.isChrome) || (this.isMobile && this.isSafari)) {
                this.on(input, 'input', function(e) {
                    var curVal = input.value;
                    var pos = icaret.caret(input);
                    var p = pos.begin;

                    if (icaret.oldVal && icaret.oldVal.length && icaret.oldVal.length > curVal.length) {
                        icaret.checkVal(input, true);

                        while (p > 0 && !icaret.tests[p - 1]) {
                            p--;
                        }

                        if (p === 0) {
                            while (p < icaret.firstNonMaskPos && !icaret.tests[p]) {
                                p++;
                            }
                        }
                    } else {
                        var lastEnteredValue = curVal.charAt(p);
                        icaret.checkVal(input, true);
                        if (p < icaret.len) {
                            if (!icaret.tests[p]) {
                                p = icaret.seekNext(p)
                            }
                            if (icaret.tests[p].test(lastEnteredValue)) {
                                p = icaret.seekNext(p)
                            }
                        }
                    }

                    setTimeout(function () {
                        icaret.caret(input, p, p)
                    }, 10)
                })
            }

            icaret.writeBuffer();

            var cookie = f.getCookie('itl-cb-pages');
            if (!cookie) {
                f.setCookie('itl-cb-pages', '0', 0);
            } else {
                f.pagesViewed = parseInt(cookie);
            }

            if (cfg.leadpolicytimespent > 0) {
                f.timeSpent = 0;
                var interVal = setInterval(function() {
                    f.timeSpent += 1;
                    if (f.timeSpent >= cfg.leadpolicytimespent) {
                        clearInterval(interVal);
                        if (f.step === 1) {
                            f.showStep(2);
                            metrika.addGoal("ITL_CALLBACK_SHOW");
                        }
                    }
                }, 1000)
            }

            if (cfg.leadpolicypagesviewed > 0) {
                f.pagesViewed++;
                if (f.pagesViewed % cfg.leadpolicypagesviewed === 0) {
                    if (f.step === 1) {
                        f.showStep(2);
                        metrika.addGoal("ITL_CALLBACK_SHOW");
                    }
                }
                f.saveState();
            }

            if (cfg.leadpolicyleft) {
                var mohandler = document.onmouseout;
                document.onmouseout = function(e) {
                    if (mohandler) mohandler(e);
                    if (f.left) return;

                    var offset = window.pageYOffset;
                    var y = e.pageY;

                    if (y < offset) {
                        if (f.step === 1) {
                            f.showStep(2);
                            f.left = true;
                            metrika.addGoal("ITL_CALLBACK_SHOW");
                        }
                    }
                }
            }
        },

        saveState : function() {
            f.setCookie('itl-cb-pages', f.pagesViewed, 0);
        },

        enableCallButton: function() {
            var button = f.getElement('itlcb-do-call');

            f.removeClass(button, 'itlcb-btn-disabled');
        },

        disableCallButton: function() {
            var button = f.getElement('itlcb-do-call');

            f.addClass(button, 'itlcb-btn-disabled');
        },

        setInfoMessage: function(msg) {
            var msgBlock = f.getElement('itlcb-info-msg');

            msgBlock.innerHTML = msg;
        },

        Timer: function(seconds, el) {
            var that = {
                el: el,
                seconds: seconds,
                totalTime: (seconds * 100) + 50,
                usedTime: 0,
                startTime: +new Date(),
                timer: null
            };

            that.count = function() {
                that.usedTime = Math.floor((+new Date() - that.startTime) / 10);

                var tt = that.totalTime - that.usedTime, mi, ss;
                if (tt <= 0) {
                    that.el.innerHTML = '00:00';
                    clearInterval(that.timer);
                    f.showStep(4);
                } else {
                    mi = Math.floor(tt / (60 * 100));
                    ss = Math.floor((tt - mi * 60 * 100) / 100);
                    that.el.innerHTML = that.fillZero(mi) + ':' + that.fillZero(ss);
                }
            };
            that.init = function() {
                if (that.timer) {
                    clearInterval(that.timer);
                    that.el.innerHTML = '00:' + seconds;
                    that.totalTime = seconds * 100;
                    that.usedTime = 0;
                    that.startTime = +new Date();
                    that.timer = null;
                }
            };
            that.start = function() {
                if (!that.timer) that.timer = setInterval(that.count, 50);
            };
            that.stop = function() {
                if (that.timer) clearInterval(that.timer);
            };
            that.fillZero = function(num) {
                return num < 10 ? '0' + num : num;
            };

            return that;
        },

        showTimer: function() {
            f.callTimer = new f.Timer(cfg.timerseconds||26, f.getElement('itlcb-timer'));
            f.callTimer.start();
        },

        sendCallRequest: function(tn) {
            if (!_conn) return;
            var params = {
                '':'callback_start',
                tn: tn,
                uid: cfg.uid,
                site: window.location.origin,
                visit_id: f.getRoistatVisitId(),
            };
            _conn.sendRequest(params, function(msg) {
                if (msg && msg.error) {
                    f.showStep(4, msg);
                } else if (msg && msg.email) {
                    f.showStep(4, msg);
                } else {
                    f.showStep(3);
                    f.showTimer();
                }
            });
        },

        getRoistatVisitId: function () {
            var roistatVisit = f.getCookie('roistat_visit');
            return roistatVisit ? roistatVisit : '';
        },

        initCall: function() {
            var val = f.getElement('itlcb-input').value;
            val = val.replace(/[^0-9\.]+/g, '');

            if (!_conn) {
                var wsProtocol;
                if (cfg.wsProtocol) {
                    wsProtocol = cfg.wsProtocol;
                } else {
                    wsProtocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
                }
                _conn = new APIConnection(wsProtocol + cfg.wsHost + '/ws', {task: 'Main', useragent: window.navigator.userAgent,
                    params: {
                        platform: window.navigator.platform,
                        appId: "Callback"
                    }});
                _conn.onConnected = function() {
                    f.sendCallRequest(val)
                };
                _conn.onError = function() {
                    f.showStep(4, {error: 'INTERNAL_ERROR'})
                };
                _conn.connect()
            } else {
                f.sendCallRequest(val);
            }
        },

        getMessage: function(data) {
            var errors, email, schedule, msg;
            if (!data) data = {};
            if (cfg.widgetcode === "1") {
                errors = {
                    'INCORRECT_WEBSITE': 'Ð—Ð²Ð¾Ð½Ð¾Ðº Ð·Ð°Ð¿Ñ€Ð¾ÑˆÐµÐ½ Ñ Ð½ÐµÐ²ÐµÑ€Ð½Ð¾Ð³Ð¾ ÑÐ°Ð¹Ñ‚Ð°.',
                    'CALL_ALREADY_SCHEDULED': 'Ð—Ð²Ð¾Ð½Ð¾Ðº Ð½Ð° Ð²Ð°Ñˆ Ð½Ð¾Ð¼ÐµÑ€ ÑƒÐ¶Ðµ</br>Ð·Ð°Ð¿Ð»Ð°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½.',
                    'CALL_ALREADY_STARTED': 'ÐÐ° Ð´Ð°Ð½Ð½Ñ‹Ð¹ Ð½Ð¾Ð¼ÐµÑ€ ÑƒÐ¶Ðµ Ð¾ÑÑƒÑ‰ÐµÑÑ‚Ð²Ð»ÑÐµÑ‚ÑÑ Ð·Ð²Ð¾Ð½Ð¾Ðº.',
                    'CALLS_LIMIT_NUMBER': 'Ð¡Ð»Ð¸ÑˆÐºÐ¾Ð¼ Ð¼Ð½Ð¾Ð³Ð¾ Ð·Ð²Ð¾Ð½ÐºÐ¾Ð²</br>Ñ Ð²Ð°ÑˆÐµÐ³Ð¾ Ð½Ð¾Ð¼ÐµÑ€Ð°. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ</br>Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð·Ð¶Ðµ.',
                    'CALLS_LIMIT_IP': 'Ð¡Ð»Ð¸ÑˆÐºÐ¾Ð¼ Ð¼Ð½Ð¾Ð³Ð¾ Ð·Ð²Ð¾Ð½ÐºÐ¾Ð²</br>Ñ Ð²Ð°ÑˆÐµÐ³Ð¾ IP Ð°Ð´Ñ€ÐµÑÐ°. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ</br>Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð·Ð¶Ðµ.'
                };
                email = 'Ð’Ð°ÑˆÐ° Ð·Ð°ÑÐ²ÐºÐ° Ð¿Ñ€Ð¸Ð½ÑÑ‚Ð° </br> Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾ Ð·Ð° Ð¾Ð±Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ðµ Ð² Ð½Ð°ÑˆÑƒ ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸ÑŽ!</br> ÐœÑ‹ ÑÐºÐ¾Ñ€Ð¾ ÑÐ²ÑÐ¶ÐµÐ¼ÑÑ Ñ Ð²Ð°Ð¼Ð¸.';
                if (cfg.targetOfftime === "true") {
                    schedule = 'Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾ Ð·Ð° Ð¾Ð±Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ðµ Ð² Ð½Ð°ÑˆÑƒ ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸ÑŽ!</br> ÐœÑ‹ ÑÐ²ÑÐ¶ÐµÐ¼ÑÑ Ñ Ð²Ð°Ð¼Ð¸ Ð² Ñ€Ð°Ð±Ð¾Ñ‡ÐµÐµ Ð²Ñ€ÐµÐ¼Ñ.';
                } else {
                    schedule = 'Ðš ÑÐ¾Ð¶Ð°Ð»ÐµÐ½Ð¸ÑŽ, Ð¼Ñ‹ ÑƒÐ¶Ðµ</br>Ð½Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÐ¼' + (data.date ? '. ÐœÐµÐ½ÐµÐ´Ð¶ÐµÑ€ ÑÐ²ÑÐ¶ÐµÑ‚ÑÑ</br>Ñ Ð²Ð°Ð¼Ð¸ Ð² ' + data.date + '.' : '.');
                }
                msg = 'Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾ Ð·Ð° Ð¾Ð±Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ðµ</br>Ð² Ð½Ð°ÑˆÑƒ ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸ÑŽ!';
            } else if (cfg.widgetcode === "2") {
                errors = {
                    'INCORRECT_WEBSITE': 'Ð—Ð²Ð¾Ð½Ð¾Ðº Ð·Ð°Ð¿Ñ€Ð¾ÑˆÐµÐ½ Ñ Ð½ÐµÐ²ÐµÑ€Ð½Ð¾Ð³Ð¾ ÑÐ°Ð¹Ñ‚Ð°.',
                    'CALL_ALREADY_SCHEDULED': 'Ð—Ð²Ð¾Ð½Ð¾Ðº Ð½Ð° Ð²Ð°Ñˆ Ð½Ð¾Ð¼ÐµÑ€ ÑƒÐ¶Ðµ Ð·Ð°Ð¿Ð»Ð°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½.',
                    'CALL_ALREADY_STARTED': 'ÐÐ° Ð´Ð°Ð½Ð½Ñ‹Ð¹ Ð½Ð¾Ð¼ÐµÑ€ ÑƒÐ¶Ðµ Ð¾ÑÑƒÑ‰ÐµÑÑ‚Ð²Ð»ÑÐµÑ‚ÑÑ Ð·Ð²Ð¾Ð½Ð¾Ðº.',
                    'CALLS_LIMIT_NUMBER': 'Ð¡Ð»Ð¸ÑˆÐºÐ¾Ð¼ Ð¼Ð½Ð¾Ð³Ð¾ Ð·Ð²Ð¾Ð½ÐºÐ¾Ð² Ñ Ð²Ð°ÑˆÐµÐ³Ð¾ Ð½Ð¾Ð¼ÐµÑ€Ð°.</br>ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð·Ð¶Ðµ.',
                    'CALLS_LIMIT_IP': 'Ð¡Ð»Ð¸ÑˆÐºÐ¾Ð¼ Ð¼Ð½Ð¾Ð³Ð¾ Ð·Ð²Ð¾Ð½ÐºÐ¾Ð² Ñ Ð²Ð°ÑˆÐµÐ³Ð¾ IP</br>Ð°Ð´Ñ€ÐµÑÐ°. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð·Ð¶Ðµ.'
                };
                email = 'Ð’Ð°ÑˆÐ° Ð·Ð°ÑÐ²ÐºÐ° Ð¿Ñ€Ð¸Ð½ÑÑ‚Ð° </br> Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾ Ð·Ð° Ð¾Ð±Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ðµ Ð² Ð½Ð°ÑˆÑƒ ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸ÑŽ! </br> ÐœÑ‹ ÑÐºÐ¾Ñ€Ð¾ ÑÐ²ÑÐ¶ÐµÐ¼ÑÑ Ñ Ð²Ð°Ð¼Ð¸.';
                if (cfg.targetOfftime === "true") {
                    schedule = 'Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾ Ð·Ð° Ð¾Ð±Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ðµ Ð² Ð½Ð°ÑˆÑƒ ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸ÑŽ!</br> ÐœÑ‹ ÑÐ²ÑÐ¶ÐµÐ¼ÑÑ Ñ Ð²Ð°Ð¼Ð¸ Ð² Ñ€Ð°Ð±Ð¾Ñ‡ÐµÐµ Ð²Ñ€ÐµÐ¼Ñ.';
                } else {
                    schedule = 'Ðš ÑÐ¾Ð¶Ð°Ð»ÐµÐ½Ð¸ÑŽ, Ð¼Ñ‹ ÑƒÐ¶Ðµ Ð½Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÐ¼' + (data.date ? '.</br>ÐœÐµÐ½ÐµÐ´Ð¶ÐµÑ€ ÑÐ²ÑÐ¶ÐµÑ‚ÑÑ Ñ Ð²Ð°Ð¼Ð¸ Ð² ' + (data.email ? '</br>' : '') + data.date + '.' : '.');
                }
                msg = 'Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾ Ð·Ð° Ð¾Ð±Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ðµ Ð² Ð½Ð°ÑˆÑƒ ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸ÑŽ!';
            } else {
                errors = {
                    'INCORRECT_WEBSITE': 'Ð—Ð²Ð¾Ð½Ð¾Ðº Ð·Ð°Ð¿Ñ€Ð¾ÑˆÐµÐ½ Ñ Ð½ÐµÐ²ÐµÑ€Ð½Ð¾Ð³Ð¾ ÑÐ°Ð¹Ñ‚Ð°.',
                    'CALL_ALREADY_SCHEDULED': 'Ð—Ð²Ð¾Ð½Ð¾Ðº Ð½Ð° Ð²Ð°Ñˆ Ð½Ð¾Ð¼ÐµÑ€ ÑƒÐ¶Ðµ</br>Ð·Ð°Ð¿Ð»Ð°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½.',
                    'CALL_ALREADY_STARTED': 'ÐÐ° Ð´Ð°Ð½Ð½Ñ‹Ð¹ Ð½Ð¾Ð¼ÐµÑ€ ÑƒÐ¶Ðµ Ð¾ÑÑƒÑ‰ÐµÑÑ‚Ð²Ð»ÑÐµÑ‚ÑÑ Ð·Ð²Ð¾Ð½Ð¾Ðº.',
                    'CALLS_LIMIT_NUMBER': 'Ð¡Ð»Ð¸ÑˆÐºÐ¾Ð¼ Ð¼Ð½Ð¾Ð³Ð¾ Ð·Ð²Ð¾Ð½ÐºÐ¾Ð²</br>Ñ Ð²Ð°ÑˆÐµÐ³Ð¾ Ð½Ð¾Ð¼ÐµÑ€Ð°. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ</br>Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð·Ð¶Ðµ.',
                    'CALLS_LIMIT_IP': 'Ð¡Ð»Ð¸ÑˆÐºÐ¾Ð¼ Ð¼Ð½Ð¾Ð³Ð¾ Ð·Ð²Ð¾Ð½ÐºÐ¾Ð² Ñ Ð²Ð°ÑˆÐµÐ³Ð¾</br>IP Ð°Ð´Ñ€ÐµÑÐ°. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð¸Ñ‚ÑŒ</br>Ð¿Ð¾Ð·Ð¶Ðµ.'
                };
                email = 'Ð’Ð°ÑˆÐ° Ð·Ð°ÑÐ²ÐºÐ° Ð¿Ñ€Ð¸Ð½ÑÑ‚Ð° </br> Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾ Ð·Ð° Ð¾Ð±Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ðµ</br>Ð² Ð½Ð°ÑˆÑƒ ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸ÑŽ!</br> ÐœÑ‹ ÑÐºÐ¾Ñ€Ð¾ ÑÐ²ÑÐ¶ÐµÐ¼ÑÑ Ñ Ð²Ð°Ð¼Ð¸.';
                if (cfg.targetOfftime === "true") {
                    schedule = 'Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾ Ð·Ð° Ð¾Ð±Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ðµ Ð² Ð½Ð°ÑˆÑƒ ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸ÑŽ!</br> ÐœÑ‹ ÑÐ²ÑÐ¶ÐµÐ¼ÑÑ Ñ Ð²Ð°Ð¼Ð¸ Ð² Ñ€Ð°Ð±Ð¾Ñ‡ÐµÐµ Ð²Ñ€ÐµÐ¼Ñ.';
                } else {
                    schedule = 'Ðš ÑÐ¾Ð¶Ð°Ð»ÐµÐ½Ð¸ÑŽ,</br>Ð¼Ñ‹ ÑƒÐ¶Ðµ Ð½Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÐ¼' + (data.date ? '.</br>ÐœÐµÐ½ÐµÐ´Ð¶ÐµÑ€ ÑÐ²ÑÐ¶ÐµÑ‚ÑÑ Ñ Ð²Ð°Ð¼Ð¸</br>Ð² ' + data.date + '.' : '.');
                }
                msg = 'Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾ Ð·Ð° Ð¾Ð±Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ðµ</br>Ð² Ð½Ð°ÑˆÑƒ ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸ÑŽ!';
            }
            if (data.error) {
                return errors[data.error] ? errors[data.error] : 'Ð’Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½ÑÑ Ð¾ÑˆÐ¸Ð±ÐºÐ°. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ';
            } else if (data.schedule) {
                return schedule;
            } else if (data.email) {
                return email;
            } else {
                return msg;
            }
        },

        showStep: function(step, data) {
            f.step = step;
            if (step === 1) {
                f.show('itlcb-call-btn');

                f.hide('itlcb-bg-fill');
                f.hide('itlcb-step2').animation(f.typeAnimation);
                f.hide('itlcb-step3');
                f.hide('itlcb-step4');
            } else if (step === 2) {
                f.show('itlcb-bg-fill');
                f.show('itlcb-step2').animation(f.typeAnimation);

                f.hide('itlcb-step3');
                f.hide('itlcb-step4');
                f.hide('itlcb-call-btn');
            } else if (step === 3) {
                f.show('itlcb-bg-fill');
                f.show('itlcb-step3');

                f.hide('itlcb-step2');
                f.hide('itlcb-step4');
                f.hide('itlcb-call-btn');
            } else if (step === 4) {
                f.show('itlcb-bg-fill');
                f.show('itlcb-step4');

                f.hide('itlcb-step2');
                f.hide('itlcb-step3');
                f.hide('itlcb-call-btn');
                var msgBlock = f.getElement('itlcb-msg-wrap');
                f.removeClass(msgBlock, 'itlcb-error');
                f.removeClass(msgBlock, 'itlcb-not-working');
                if (f.callTimer) f.callTimer.stop();
                if (data && data.error) {
                    if (data.error === 'NOT_WORKING_TIME') {
                        this.setInfoMessage(this.getMessage({ schedule: true, date: data.date, email: data.email }));
                        f.addClass(msgBlock, 'itlcb-not-working');
                    } else {
                        this.setInfoMessage(this.getMessage({ error: data.error }));
                        f.addClass(msgBlock, 'itlcb-error');
                    }
                } else if (data && data.email) {
                    this.setInfoMessage(this.getMessage({ email: data.email }));
                } else {
                    this.setInfoMessage(this.getMessage());
                }
            }
        }
    };

    if (cfg.enabled) {
        f.appendStyle();
        f.initWidget()
    }

})(document);
</script>


</body>
</html>